"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.cacheable = void 0;
require("reflect-metadata");
const rxjs_1 = require("rxjs");
const operators_1 = require("rxjs/operators");
const helpers_1 = require("./helpers");
function cacheable(func, timeout = 0, isPromise = false) {
    const cache = {};
    return function (...args) {
        const key = helpers_1.hash(args);
        if (!cache[key]) {
            const rawResult = helpers_1.toPromise(func.bind(this), args);
            const result = rxjs_1.from(rawResult).pipe(operators_1.tap((value) => {
                cache[key] = isPromise ? Promise.resolve(value) : rxjs_1.of(value);
                setTimeout(() => {
                    delete cache[key];
                }, timeout);
            }), operators_1.catchError((error) => {
                cache[key] = isPromise ? Promise.reject(error) : rxjs_1.throwError(error);
                throw error;
            }));
            cache[key] = isPromise
                ? new Promise((resolve, reject) => {
                    result.subscribe((val) => {
                        resolve(val);
                    }, (error) => {
                        reject(error);
                    });
                })
                : result;
        }
        return cache[key];
    };
}
exports.cacheable = cacheable;
//# sourceMappingURL=cacheable.js.map